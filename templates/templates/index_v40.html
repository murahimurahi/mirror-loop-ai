<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mirror Loop v0.4.0</title>
<style>
:root{ --panel: rgba(18,26,44,.6); --ink:#eaf7ff; --muted:#9db5c9; --accent:#00b7ff; }
html,body{height:100%;margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,sans-serif;color:var(--ink);}
body{
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);
  animation:breatheBg 9s ease-in-out infinite alternate;
}
@keyframes breatheBg{
  0%{background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);}
  100%{background: radial-gradient(1100px 1100px at 50% 52%, #0e244b, #061126 60%, #02060f 100%);}
}
.card{width:min(94vw,420px);background:var(--panel);backdrop-filter:blur(18px);border-radius:20px;padding:22px 22px 16px;box-shadow:0 20px 60px rgba(0,0,0,.35);}
h1{margin:0 0 10px;font-size:1.05rem;color:#8dd4ff;text-align:center;}
.hint{margin:6px 0 12px;font-size:.85rem;color:var(--muted);text-align:center;}
.row{display:flex;gap:8px;}
input{
  width:100%;padding:12px 14px;border-radius:12px;border:none;outline:none;
  background:rgba(255,255,255,.08);color:var(--ink);font-size:1rem;
}
input::placeholder{color:#8aa0b3;}
.btn{
  position:relative;border:none;outline:none;cursor:pointer;color:white;border-radius:12px;
  padding:12px 14px;font-weight:700;flex:1;background:linear-gradient(90deg,#0a84ff,#00b7ff);
  transition: box-shadow .25s, transform .05s; overflow:hidden;
}
.btn:hover{ box-shadow:0 0 22px rgba(0,183,255,.45); }
.btn:active{ transform:translateY(1px); }
.btn::after{
  content:""; position:absolute; top:50%; left:50%; width:0; height:0; opacity:0;
  background:rgba(255,255,255,.45); border-radius:50%; transform:translate(-50%,-50%);
  transition: width .55s ease, height .55s ease, opacity .55s ease;
}
.btn:active::after{ width:260%; height:260%; opacity:0; }
.btn.secondary{ background:linear-gradient(90deg,#1b9aaa,#35d0c0); }
.btn.danger{ background:linear-gradient(90deg,#ff5757,#ff8a8a); }
.btn.listening{ box-shadow:0 0 18px rgba(255,120,120,.6); animation:pulse 1s infinite; }
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

.result{ margin-top:12px;background:rgba(255,255,255,.05);border-radius:12px;padding:12px;min-height:110px;font-size:.98rem;line-height:1.65;}
.block{ margin:2px 0 8px; }
.sep{ height:8px; }
.footer{ margin-top:8px;font-size:.8rem;color:#86a3b8;text-align:center;}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ’ Mirror Loop v0.4.0</h1>
    <div class="hint">Reflectã§è¿”ç­”ã€èª­ã¿ä¸Šã’ã¯è‹¥ã„ç”·æ€§ãƒœã‚¤ã‚¹å¯¾å¿œï¼ˆChromeæ¨å¥¨ï¼‰</div>

    <input id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ" autocomplete="off"/>

    <div class="row" style="margin-top:10px;">
      <button id="reflectBtn" class="btn">Reflect</button>
      <button id="speakBtn" class="btn secondary">ğŸ”Š èª­ã¿ä¸Šã’</button>
      <button id="micBtn" class="btn danger">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
    </div>

    <div id="result" class="result">
      <div id="b1" class="block"></div>
      <div class="sep"></div>
      <div id="b2" class="block"></div>
      <div class="sep"></div>
      <div id="b3" class="block"></div>
    </div>

    <div class="footer">ğŸ™ï¸ éŸ³å£°å…¥åŠ›/å‡ºåŠ›ã¯ Chrome ã¾ãŸã¯ Edge æ¨å¥¨</div>
  </div>

<script>
const $ = s => document.querySelector(s);
const input = $("#userInput");
const reflectBtn = $("#reflectBtn");
const speakBtn = $("#speakBtn");
const micBtn = $("#micBtn");
const b1=$("#b1"), b2=$("#b2"), b3=$("#b3");

function cleanLineStarts(t){
  if(!t) return "";
  t = t.replace(/^\s*(?:\(?\s*[\dï¼-ï¼™]+\s*\)?[\.ï¼\)]\s*)/gm, "");
  t = t.replace(/^(è¦ç´„|åŠ©è¨€|æ¬¡ã®ä¸€è¨€|ã‚«ãƒ†ã‚´ãƒª)\s*[:ï¼š]\s*/gm, "");
  t = t.replace(/[ğŸ’¡â­ï¸âœ¨ğŸ”¥âœ…â–¶ï¸â¤â†’â€¢â—â—†â– â—‰â€»â˜…â˜†â—â—‹â—â–²â–³â– â–¡â—†â—‡]/g, "");
  return t.trim();
}

function renderReply(obj){
  const s = cleanLineStarts(obj?.summary||"");
  const a = cleanLineStarts(obj?.advice ||"");
  const n = cleanLineStarts(obj?.next   ||"");
  b1.textContent = s; b2.textContent = a; b3.textContent = n;
  document.body.dataset.tts = [s,a,n].filter(Boolean).join("ã€‚");
}

reflectBtn.addEventListener("click", async ()=>{
  const text = input.value.trim();
  if(!text){ alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  reflectBtn.disabled = true;
  b1.textContent="è€ƒãˆã¦ã„ã¾ã™â€¦"; b2.textContent=""; b3.textContent="";
  try{
    const r = await fetch("/reflect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_input:text})});
    const data = await r.json();
    if(data.reply){ renderReply(data.reply); input.value=""; }
    else{ b1.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (data.error||""); }
  }catch{ b1.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
  finally{ reflectBtn.disabled=false; }
});

// éŸ³å£°å…¥åŠ›
let recognition;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang="ja-JP"; recognition.continuous=false; recognition.interimResults=false;
  micBtn.addEventListener("click", ()=>{
    if(micBtn.classList.contains("listening")) recognition.stop();
    else{ recognition.start(); micBtn.classList.add("listening"); micBtn.textContent="ğŸ›‘ åœæ­¢"; }
  });
  recognition.onresult = e => { input.value = e.results[0][0].transcript; };
  recognition.onend    = () => { micBtn.classList.remove("listening"); micBtn.textContent="ğŸ¤ éŸ³å£°å…¥åŠ›"; };
}else{ micBtn.disabled=true; micBtn.textContent="ğŸ¤ éå¯¾å¿œ"; }

// è‹¥ã„ç”·æ€§ãƒœã‚¤ã‚¹
function pickYoungMaleVoice(){
  const vs = speechSynthesis.getVoices();
  const prefer = ["Takumi","Daichi","Kenta","Ichiro","Google æ—¥æœ¬èª","Japanese Male"];
  for(const n of prefer){ const v=vs.find(x=>(x.name||"").includes(n)); if(v)return v; }
  const jp = vs.filter(v=>v.lang==="ja-JP"); return jp[0]||vs[0]||null;
}

// ã‚¤ã‚±ãƒœï¼šæ»‘ã‚‰ã‹ã§æ˜ã‚‹ã‚ãƒ»è‹¥ã„ç”·æ€§
speakBtn.addEventListener("click", ()=>{
  const text = cleanLineStarts(document.body.dataset.tts||"");
  if(!text){ alert("èª­ã¿ä¸Šã’ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  speechSynthesis.cancel();
  const voice = pickYoungMaleVoice();
  const sentences = text.split(/(?<=[ã€‚ï¼ï¼Ÿ!?])/).filter(Boolean);
  let i=0;
  const speakNext=()=>{
    if(i>=sentences.length)return;
    const u=new SpeechSynthesisUtterance(sentences[i]);
    u.lang="ja-JP"; u.rate=1.15; u.pitch=1.07; u.volume=1.0;
    if(voice)u.voice=voice;
    if(/(ã­|ã‚ˆ|ã‹ãª|ã‹ã‚‚|ã§ã—ã‚‡ã†|ã­ã‡)/.test(sentences[i]))u.pitch=1.15;
    if(/(å¤§ä¸ˆå¤«|å®‰å¿ƒ|è½ã¡ç€|é ‘å¼µ|å…ƒæ°—)/.test(sentences[i]))u.rate=1.02;
    speechSynthesis.speak(u);
    u.onend=()=>setTimeout(()=>{i++;speakNext();},180);
  };
  if(speechSynthesis.getVoices().length===0){
    speechSynthesis.onvoiceschanged=()=>speakNext();
  }else{speakNext();}
});
</script>
</body>
</html>
