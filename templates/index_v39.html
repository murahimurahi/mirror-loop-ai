<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mirror Loop v0.3.9</title>
<style>
  :root{ --panel: rgba(18,26,44,.6); --ink:#eaf7ff; --muted:#9db5c9; --accent: #00b7ff; }
  html,body{height:100%; margin:0; font-family: "Noto Sans JP", system-ui, -apple-system, Segoe UI, sans-serif; color: var(--ink);}
  body{
    display:flex; align-items:center; justify-content:center; overflow:hidden;
    background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);
    animation: breatheBg 9s ease-in-out infinite alternate;
  }
  @keyframes breatheBg{
    0%{ background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);}
    100%{background: radial-gradient(1100px 1100px at 50% 52%, #0e244b, #061126 60%, #02060f 100%);}
  }
  .card{
    width:min(94vw,420px); background:var(--panel); backdrop-filter: blur(18px);
    border-radius:20px; padding:22px 22px 16px; box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  h1{margin:0 0 10px; font-size:1.05rem; color:#8dd4ff; text-align:center;}
  .hint{margin:6px 0 12px; font-size:.85rem; color:var(--muted); text-align:center;}
  .row{display:flex; gap:8px;}
  input{
    width:100%; padding:12px 14px; border-radius:12px; border:none; outline:none;
    background:rgba(255,255,255,.08); color:var(--ink); font-size:1rem;
  }
  input::placeholder{ color:#8aa0b3;}
  .btn{
    position:relative; border:none; outline:none; cursor:pointer; color:white;
    border-radius:12px; padding:12px 14px; font-weight:700; flex:1;
    background: linear-gradient(90deg, #0a84ff, #00b7ff);
    transition: box-shadow .25s transform .05s;
    overflow:hidden;
  }
  .btn:hover{ box-shadow:0 0 22px rgba(0,183,255,.45); }
  .btn:active{ transform: translateY(1px); }
  .btn::after{
    content:""; position:absolute; top:50%; left:50%; width:0; height:0; opacity:0;
    background: rgba(255,255,255,.45); border-radius:50%; transform:translate(-50%,-50%);
    transition: width .55s ease, height .55s ease, opacity .55s ease;
  }
  .btn:active::after{ width:260%; height:260%; opacity:0; }
  .btn.secondary{ background: linear-gradient(90deg, #1b9aaa, #35d0c0); }
  .btn.danger{ background: linear-gradient(90deg, #ff5757, #ff8a8a); }
  .btn.listening{ box-shadow:0 0 18px rgba(255,120,120,.6); animation:pulse 1s infinite; }
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

  .result{
    margin-top:12px; background: rgba(255,255,255,.05); border-radius:12px; padding:12px 12px 10px; min-height:110px;
    font-size:.98rem; line-height:1.65;
  }
  .kvs{ display:grid; grid-template-columns: 68px 1fr; gap:6px 10px; }
  .k{ color:#81cfff; text-align:right; }
  .v{ color:#e9f6ff; }
  .footer{ margin-top:8px; font-size:.8rem; color:#86a3b8; text-align:center;}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ’ Mirror Loop v0.3.9</h1>
    <div class="hint">ä¾‹æ–‡ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ãã¨æ¶ˆãˆã¾ã™ã€‚Reflectå¾Œã€å…¥åŠ›æ¬„ã¯è‡ªå‹•ã‚¯ãƒªã‚¢ã€‚</div>

    <input id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ" autocomplete="off" />

    <div class="row" style="margin-top:10px;">
      <button id="reflectBtn" class="btn">Reflect</button>
      <button id="speakBtn" class="btn secondary">ğŸ”Š èª­ã¿ä¸Šã’</button>
      <button id="micBtn" class="btn danger">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
    </div>

    <div id="result" class="result">
      <div class="kvs" id="kvsArea" style="display:none;"></div>
      <div id="rawArea" style="display:none;"></div>
    </div>

    <div class="footer">ğŸ™ï¸ éŸ³å£°å…¥åŠ›ï¼å‡ºåŠ›ã¯ Chrome æ¨å¥¨</div>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const input = $("#userInput");
  const reflectBtn = $("#reflectBtn");
  const speakBtn = $("#speakBtn");
  const micBtn = $("#micBtn");
  const kvsArea = $("#kvsArea");
  const rawArea = $("#rawArea");

  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è‡ªå‹•ã‚¯ãƒªã‚¢å¾©å¸°
  input.addEventListener("focus", ()=> input.placeholder = "");
  input.addEventListener("blur", ()=> { if(!input.value) input.placeholder = "ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ"; });

  // æ•°å­—ãƒ»ãƒ©ãƒ™ãƒ«ãƒ»è¨˜å·ã‚’å¾¹åº•é™¤å»ï¼ˆèª­ã¿ä¸Šã’ç”¨ï¼‰
  function cleanForTTS(text){
    if(!text) return "";
    return text
      .replace(/^\s*[\dï¼-ï¼™]+[)\.ï¼]\s*/gm, "")     // 1. / ï¼‘ï¼ / 1) ã‚’è¡Œé ­ã§é™¤å»
      .replace(/^\s*[ãƒ»\-ï¼Š*]\s*/gm, "")            // ç®‡æ¡æ›¸ãè¨˜å·
      .replace(/(è¦ç´„|åŠ©è¨€|æ¬¡ã®ä¸€è¨€|ã‚«ãƒ†ã‚´ãƒª)\s*[:ï¼š]\s*/g, "") // ãƒ©ãƒ™ãƒ«
      .replace(/[ğŸ’¡â­ï¸âœ¨ğŸ”¥âœ…â–¶ï¸â¤â†’â€¢â—â—†â– â—‰â€»â˜…â˜†â—â—‹â—â–²â–³â– â–¡â—†â—‡â–¶â–·â¤â”âœ]/g, "")
      .replace(/\s+/g, " ")
      .replace(/\n+/g, "ã€‚")
      .replace(/[ã€‚]{2,}/g, "ã€‚")
      .trim();
  }

  // ç”»é¢è¡¨ç¤ºï¼ˆãƒ©ãƒ™ãƒ«ã¯**å‡ºã•ãªã„**ï¼‰
  function renderReply(obj){
    if(obj && (obj.summary || obj.advice || obj.next)){
      kvsArea.style.display = "grid";
      rawArea.style.display = "none";
      kvsArea.innerHTML = "";

      const rows = [
        ["è¦ç‚¹", (obj.summary||"").trim()],
        ["åŠ©è¨€", (obj.advice||"").trim()],
        ["ã²ã¨è¨€", (obj.next||"").trim()],
      ];
      for(const [k,v] of rows){
        const kEl = document.createElement("div"); kEl.className="k"; kEl.textContent=k;
        const vEl = document.createElement("div"); vEl.className="v"; vEl.textContent=v;
        kvsArea.appendChild(kEl); kvsArea.appendChild(vEl);
      }
      // èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
      rawArea.dataset.tts = cleanForTTS(rows.map(([_,v])=>v).join("ã€‚"));
    }else{
      kvsArea.style.display = "none";
      rawArea.style.display = "block";
      rawArea.textContent = (typeof obj === "string" ? obj : JSON.stringify(obj));
      rawArea.dataset.tts = cleanForTTS(rawArea.textContent);
    }
  }

  // Reflect
  reflectBtn.addEventListener("click", async ()=>{
    const text = input.value.trim();
    if(!text){ alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    reflectBtn.disabled = true;
    renderReply("è€ƒãˆã¦ã„ã¾ã™â€¦");
    try{
      const res = await fetch("/reflect", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({user_input:text})
      });
      const data = await res.json();
      if(data.reply){
        renderReply(data.reply);
        input.value = "";  // é€ä¿¡å¾Œã«å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
      }else{
        renderReply("ã‚¨ãƒ©ãƒ¼ï¼š" + (data.error||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
      }
    }catch(e){
      renderReply("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }finally{
      reflectBtn.disabled = false;
    }
  });

  // éŸ³å£°å…¥åŠ›
  let recognition;
  if('webkitSpeechRecognition' in window){
    recognition = new webkitSpeechRecognition();
    recognition.lang = "ja-JP"; recognition.continuous = false; recognition.interimResults = false;

    micBtn.addEventListener("click", ()=>{
      if(micBtn.classList.contains("listening")){ recognition.stop(); }
      else{ recognition.start(); micBtn.classList.add("listening"); micBtn.textContent="ğŸ›‘ åœæ­¢"; }
    });
    recognition.onresult = e => { input.value = e.results[0][0].transcript; };
    recognition.onend = () => { micBtn.classList.remove("listening"); micBtn.textContent="ğŸ¤ éŸ³å£°å…¥åŠ›"; };
    recognition.onerror = () => { micBtn.classList.remove("listening"); micBtn.textContent="ğŸ¤ éŸ³å£°å…¥åŠ›"; };
  }else{
    micBtn.disabled = true; micBtn.textContent = "ğŸ¤ éå¯¾å¿œ";
  }

  // èª­ã¿ä¸Šã’ï¼ˆã‚¤ã‚±ãƒœå¯„ã‚Šãƒ»æ–‡æ¯ã«é–“ã‚’ç½®ãï¼‰
  speakBtn.addEventListener("click", ()=>{
    const text = rawArea.dataset.tts || "";
    if(!text){ alert("èª­ã¿ä¸Šã’ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    if(!("speechSynthesis" in window)){ alert("éŸ³å£°å‡ºåŠ›éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™"); return; }

    speechSynthesis.cancel();
    const sentences = text.split(/(?<=[ã€‚ï¼ï¼Ÿ!?])/).filter(Boolean);

    const base = { lang:"ja-JP", rate:0.93, pitch:0.85, volume:1.0 }; // ä½ã‚=ã‚¤ã‚±ãƒœå¯„ã‚Š
    let i = 0;
    const speakNext = ()=>{
      if(i>=sentences.length) return;
      const u = new SpeechSynthesisUtterance(sentences[i]);
      Object.assign(u, base);
      // å°‘ã—æŠ‘æš
      if(/(ã‚ˆã­|ã ã­|ã‹ãª)/.test(sentences[i])) u.pitch = 1.0;
      if(/(å¤§ä¸ˆå¤«|å®‰å¿ƒ|ã‚†ã£ãã‚Š|è½ã¡ç€)/.test(sentences[i])) u.rate = 0.9;
      // æ—¥æœ¬èªãƒœã‚¤ã‚¹ã‚’å„ªå…ˆ
      const vs = speechSynthesis.getVoices();
      u.voice = vs.find(v=> v.name.includes("Japanese") || v.name.includes("æ—¥æœ¬èª") || v.lang==="ja-JP") || null;

      speechSynthesis.speak(u);
      u.onend = ()=> setTimeout(()=>{ i++; speakNext(); }, 280);
    };
    speakNext();
  });
</script>
</body>
</html>
