<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mirror Loop v0.3.9</title>
<style>
:root{ --panel: rgba(18,26,44,.6); --ink:#eaf7ff; --muted:#9db5c9; --accent:#00b7ff; }
html,body{height:100%;margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,sans-serif;color:var(--ink);}
body{
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);
  animation:breatheBg 9s ease-in-out infinite alternate;
}
@keyframes breatheBg{
  0%{background: radial-gradient(1000px 1000px at 50% 52%, #0b1d3a, #040a16 60%, #02060f 100%);}
  100%{background: radial-gradient(1100px 1100px at 50% 52%, #0e244b, #061126 60%, #02060f 100%);}
}
.card{width:min(94vw,420px);background:var(--panel);backdrop-filter:blur(18px);border-radius:20px;padding:22px 22px 16px;box-shadow:0 20px 60px rgba(0,0,0,.35);}
h1{margin:0 0 10px;font-size:1.05rem;color:#8dd4ff;text-align:center;}
.hint{margin:6px 0 12px;font-size:.85rem;color:var(--muted);text-align:center;}
.row{display:flex;gap:8px;}
input{
  width:100%;padding:12px 14px;border-radius:12px;border:none;outline:none;
  background:rgba(255,255,255,.08);color:var(--ink);font-size:1rem;
}
input::placeholder{color:#8aa0b3;}
.btn{
  position:relative;border:none;outline:none;cursor:pointer;color:white;border-radius:12px;
  padding:12px 14px;font-weight:700;flex:1;background:linear-gradient(90deg,#0a84ff,#00b7ff);
  transition: box-shadow .25s, transform .05s; overflow:hidden;
}
.btn:hover{ box-shadow:0 0 22px rgba(0,183,255,.45); }
.btn:active{ transform:translateY(1px); }
.btn::after{
  content:""; position:absolute; top:50%; left:50%; width:0; height:0; opacity:0;
  background:rgba(255,255,255,.45); border-radius:50%; transform:translate(-50%,-50%);
  transition: width .55s ease, height .55s ease, opacity .55s ease;
}
.btn:active::after{ width:260%; height:260%; opacity:0; }
.btn.secondary{ background:linear-gradient(90deg,#1b9aaa,#35d0c0); }
.btn.danger{ background:linear-gradient(90deg,#ff5757,#ff8a8a); }
.btn.listening{ box-shadow:0 0 18px rgba(255,120,120,.6); animation:pulse 1s infinite; }
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

.result{ margin-top:12px;background:rgba(255,255,255,.05);border-radius:12px;padding:12px;min-height:110px;font-size:.98rem;line-height:1.65;}
.block{ margin:2px 0 8px; }
.sep{ height:8px; }
.footer{ margin-top:8px;font-size:.8rem;color:#86a3b8;text-align:center;}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ’ Mirror Loop v0.3.9</h1>
    <div class="hint">ä¾‹æ–‡ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ãã¨æ¶ˆãˆã¾ã™ã€‚Reflectå¾Œã¯å…¥åŠ›æ¬„ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢ã€‚</div>

    <input id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ" autocomplete="off" />

    <div class="row" style="margin-top:10px;">
      <button id="reflectBtn" class="btn">Reflect</button>
      <button id="speakBtn" class="btn secondary">ğŸ”Š èª­ã¿ä¸Šã’</button>
      <button id="micBtn" class="btn danger">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
    </div>

    <div id="result" class="result">
      <!-- ãƒ©ãƒ™ãƒ«ã¯å‡ºã•ãšã€3ãƒ–ãƒ­ãƒƒã‚¯ã®ã¿è¡¨ç¤º -->
      <div id="b1" class="block"></div>
      <div class="sep"></div>
      <div id="b2" class="block"></div>
      <div class="sep"></div>
      <div id="b3" class="block"></div>
    </div>

    <div class="footer">ğŸ™ï¸ éŸ³å£°å…¥åŠ›/å‡ºåŠ›ã¯ Chrome æ¨å¥¨ï¼ˆEdge ã§ã‚‚å¯ï¼‰</div>
  </div>

<script>
const $ = s => document.querySelector(s);
const input = $("#userInput");
const reflectBtn = $("#reflectBtn");
const speakBtn = $("#speakBtn");
const micBtn = $("#micBtn");
const b1=$("#b1"), b2=$("#b2"), b3=$("#b3");

input.addEventListener("focus", ()=> input.placeholder="");
input.addEventListener("blur", ()=>{ if(!input.value) input.placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ"; });

// æ–‡å­—åˆ—ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼šè¡Œé ­ã®ç•ªå·/ãƒ©ãƒ™ãƒ«/è¨˜å·ã‚’é™¤å¤–ï¼ˆèª­ã¿ä¸Šã’ï¼†è¡¨ç¤ºã®ä¸¡æ–¹ã§ä½¿ç”¨ï¼‰
function cleanLineStarts(t){
  if(!t) return "";
  // 1. / ï¼‘ï¼ / (1) / 1) ã‚’è¡Œé ­ã‹ã‚‰é™¤å»
  t = t.replace(/^\s*[\dï¼-ï¼™]+[\.\)ï¼]\s*|\s*^\(\s*[\dï¼-ï¼™]+\s*\)\s*/gm, "");
  // ãƒ©ãƒ™ãƒ«èª
  t = t.replace(/^(è¦ç´„|åŠ©è¨€|æ¬¡ã®ä¸€è¨€|ã‚«ãƒ†ã‚´ãƒª)\s*[:ï¼š]\s*/gm, "");
  // ç®‡æ¡æ›¸ãè¨˜å·
  t = t.replace(/^\s*[ãƒ»\-ï¼Š*â€¢â—â—†â– â—‰â–¶â–·â¤â†’]\s*/gm, "");
  // çµµæ–‡å­—ãƒ»è£…é£¾è¨˜å·ï¼ˆä»£è¡¨çš„ï¼‰
  t = t.replace(/[ğŸ’¡â­ï¸âœ¨ğŸ”¥âœ…â–¶ï¸â¤â†’â€¢â—â—†â– â—‰â€»â˜…â˜†â—â—‹â—â–²â–³â– â–¡â—†â—‡â–¶â–·â¤â”âœ]/g, "");
  return t.trim();
}

// ç”»é¢è¡¨ç¤ºï¼ˆãƒ©ãƒ™ãƒ«ç„¡ã—ï¼‰
function renderReply(obj){
  const s = cleanLineStarts(obj?.summary||"");
  const a = cleanLineStarts(obj?.advice||"");
  const n = cleanLineStarts(obj?.next||"");
  b1.textContent = s;
  b2.textContent = a;
  b3.textContent = n;
  // èª­ã¿ä¸Šã’ç”¨æœ¬æ–‡ã‚’ä¿æŒ
  document.body.dataset.tts = [s,a,n].filter(Boolean).join("ã€‚");
}

// Reflect
reflectBtn.addEventListener("click", async ()=>{
  const text = input.value.trim();
  if(!text){ alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  reflectBtn.disabled = true;
  b1.textContent="è€ƒãˆã¦ã„ã¾ã™â€¦"; b2.textContent=""; b3.textContent="";
  try{
    const r = await fetch("/reflect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_input:text})});
    const data = await r.json();
    if(data.reply){ renderReply(data.reply); input.value=""; }
    else{ b1.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (data.error||""); }
  }catch{ b1.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
  finally{ reflectBtn.disabled=false; }
});

// éŸ³å£°å…¥åŠ›ï¼ˆChromeï¼‰
let recognition;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang="ja-JP"; recognition.continuous=false; recognition.interimResults=false;
  micBtn.addEventListener("click", ()=>{
    if(micBtn.classList.contains("listening")) recognition.stop();
    else{ recognition.start(); micBtn.classList.add("listening"); micBtn.textContent="ğŸ›‘ åœæ­¢"; }
  });
  recognition.onresult = e => { input.value = e.results[0][0].transcript; };
  recognition.onend    = () => { micBtn.classList.remove("listening"); micBtn.textContent="ğŸ¤ éŸ³å£°å…¥åŠ›"; };
  recognition.onerror  = () => { micBtn.classList.remove("listening"); micBtn.textContent="ğŸ¤ éŸ³å£°å…¥åŠ›"; };
}else{
  micBtn.disabled = true; micBtn.textContent = "ğŸ¤ éå¯¾å¿œ";
}

// è‹¥ã„ç”·æ€§å¯„ã‚Šã®ãƒœã‚¤ã‚¹é¸æŠï¼ˆç’°å¢ƒã«ã‚ˆã‚Šåç§°å·®ç•°ã‚ã‚Šï¼‰
function pickYoungMaleVoice(){
  const vs = speechSynthesis.getVoices();
  // ç”·æ€§ã£ã½ã„æ—¥æœ¬èªãƒœã‚¤ã‚¹å€™è£œ
  const prefer = [
    "Ichiro","Takumi","Daichi","Kouta","Tarou","Hattori",
    "Google æ—¥æœ¬èª","Google æ—¥æœ¬èªï¼ˆæ—¥æœ¬ï¼‰","Japanese"
  ];
  // 1) åå‰ã§å„ªå…ˆ
  for(const name of prefer){
    const hit = vs.find(v => (v.name||"").includes(name));
    if(hit) return hit;
  }
  // 2) æ—¥æœ¬èªã®ä¸­ã‹ã‚‰ç”·æ€§ã£ã½ã„åå‰
  const jp = vs.filter(v => v.lang==="ja-JP" || (v.name||"").includes("æ—¥æœ¬èª") || (v.name||"").includes("Japanese"));
  if(jp.length) return jp[0];
  return vs[0] || null;
}

// èª­ã¿ä¸Šã’ï¼ˆè‹¥ã„ç”·æ€§å¯„ã‚Šï¼šã‚„ã‚„ä½ã‚ãƒ»å°‘ã—é€Ÿã‚ã€æŠ‘æšã‚ã‚Šï¼‰
speakBtn.addEventListener("click", ()=>{
  const text = cleanLineStarts(document.body.dataset.tts||"");
  if(!text){ alert("èª­ã¿ä¸Šã’ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  if(!("speechSynthesis" in window)){ alert("éŸ³å£°å‡ºåŠ›éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™"); return; }

  speechSynthesis.cancel();
  const sentences = text.split(/(?<=[ã€‚ï¼ï¼Ÿ!?])/).filter(Boolean);

  const base = { lang:"ja-JP", rate:1.03, pitch:0.92, volume:1.0 }; // è‹¥ã„ç”·æ€§å¯„ã‚Š
  const voice = pickYoungMaleVoice();

  let i=0;
  const speakNext = ()=>{
    if(i>=sentences.length) return;
    const u = new SpeechSynthesisUtterance(sentences[i]);
    Object.assign(u, base);
    if(voice) u.voice = voice;
    // ã»ã‚“ã®ã‚ŠæŠ‘æš
    if(/(ã‚ˆã­|ã ã­|ã‹ãª|ã‹ã‚‚)/.test(sentences[i])) u.pitch = 1.0;
    if(/(å¤§ä¸ˆå¤«|å®‰å¿ƒ|ã‚†ã£ãã‚Š|è½ã¡ç€)/.test(sentences[i])) u.rate = 0.97;
    speechSynthesis.speak(u);
    u.onend = ()=> setTimeout(()=>{ i++; speakNext(); }, 240);
  };
  // ä¸€éƒ¨ç’°å¢ƒã§ã¯ getVoices() éåŒæœŸæ›´æ–°ã®ãŸã‚é…å»¶é–‹å§‹
  if(speechSynthesis.getVoices().length===0){
    window.speechSynthesis.onvoiceschanged = ()=>speakNext();
  }else{
    speakNext();
  }
});
</script>
</body>
</html>
