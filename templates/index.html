<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mirror Loop</title>
<!-- Chart.js CDNï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{ --panel: rgba(18,26,44,.6); --ink:#eaf7ff; --muted:#9db5c9; --accent:#00b7ff; }
html,body{height:100%;margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,sans-serif;color:var(--ink);}
body{display:flex;flex-direction:column;align-items:center;padding:40px;background:radial-gradient(1000px 1000px at 50% 52%,#0b1d3a,#040a16 60%,#02060f 100%);animation:breatheBg 9s ease-in-out infinite alternate;}
@keyframes breatheBg{0%{background:radial-gradient(1000px 1000px at 50% 52%,#0b1d3a,#040a16 60%,#02060f 100%);}100%{background:radial-gradient(1100px 1100px at 50% 52%,#0e244b,#061126 60%,#02060f 100%);}}

/* ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ */
.catch{text-align:center;color:#eaf2ff;margin-bottom:30px;max-width:820px;}
.catch h1{font-size:1.6rem;background:linear-gradient(90deg,#8fd3f4,#84fab0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.catch p{font-size:1.1rem;color:#b8c8e6;}

/* ã‚«ãƒ¼ãƒ‰ */
.card{width:min(96vw,780px);background:var(--panel);backdrop-filter:blur(18px);border-radius:20px;padding:22px;margin-bottom:20px;box-shadow:0 20px 60px rgba(0,0,0,.35);}
h1{margin:0 0 10px;font-size:1.05rem;color:#8dd4ff;text-align:left;}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:none;background:rgba(255,255,255,.08);color:var(--ink);}
textarea{min-height:70px;resize:vertical;}
.btn{border:none;cursor:pointer;color:white;border-radius:12px;padding:12px 14px;font-weight:700;background:linear-gradient(90deg,#0a84ff,#00b7ff);transition:box-shadow .25s,transform .05s;}
.btn:hover{box-shadow:0 0 22px rgba(0,183,255,.45);}
.btn:active{transform:translateY(1px);}
.btn.alt{background:linear-gradient(90deg,#24c6dc,#514a9d)}
.btn.ghost{background:rgba(255,255,255,.12)}
.result{margin-top:12px;background:rgba(255,255,255,.05);border-radius:12px;padding:12px;min-height:110px;white-space:pre-wrap;}

/* æ—¥è¨˜ãƒ»ä¸€è¦§ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.box{background:rgba(255,255,255,.05);border-radius:12px;padding:16px;}
.box h2{margin:0 0 10px;font-size:1.05rem;color:#9cc8ff;}
.entry{background:rgba(255,255,255,.06);margin-bottom:10px;border-radius:8px;padding:8px 12px;}
.entry-date{color:#a9bcd4;font-size:.85rem;}
.entry-text{white-space:pre-wrap;margin-top:4px;}
.summaryBox{background:rgba(255,255,255,.08);padding:10px;border-radius:10px;margin-top:12px;font-size:.95rem;}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* ã‚°ãƒ©ãƒ• */
canvas{background:rgba(255,255,255,.03);border-radius:12px;padding:8px}
</style>
</head>
<body>
<div class="catch">
  <h1>ãƒ¢ãƒ¤ã£ã¨ã—ãŸã¾ã¾ã§å¿ƒãŒãã¡ã‚ƒãã¡ã‚ƒã ã¨å‰ã«é€²ã‚ãªã„ã€‚</h1>
  <p>AIã«å¿ƒã®ä¸­ã‚’æ•´ç†ã—ã¦ã‚‚ã‚‰ã„ã€ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã¯ã€Œå¿ƒã‚’æ˜ ã™AIæ—¥è¨˜ã‚¢ãƒ—ãƒªã€ã§ã™ã€‚</p>
</div>

<div class="card">
  <h1>ğŸ’ Mirror Loop</h1>
  <textarea id="userInput" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ°—æŒã¡ã‚’è‡ªç”±ã«ã¤ã¶ã‚„ãâ€¦"></textarea>
  <div class="row" style="margin-top:10px;">
    <button id="reflectBtn" class="btn">Reflectï¼ˆAIã«è¿”ã—ã¦ã‚‚ã‚‰ã†ï¼‰</button>
    <button id="summarizeBtn" class="btn alt">ä»Šæ—¥ã®ã¾ã¨ã‚ï¼ˆAIè¦ç´„ï¼‰</button>
    <button id="readBtn" class="btn ghost">ã¾ã¨ã‚ã‚’æœ—èª­ï¼ˆã‚¤ã‚±ãƒœï¼‰</button>
  </div>
  <div id="result" class="result"></div>
</div>

<div class="two-col" style="width:min(96vw,780px);">
  <div class="box">
    <h2>ğŸ“˜ æ—¥è¨˜ä¸€è¦§ï¼ˆç›´è¿‘ï¼‰</h2>
    <div id="entries"></div>
  </div>
  <div class="box">
    <h2>ğŸ“ˆ æ°—åˆ†ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆç›´è¿‘7æ—¥ï¼‰</h2>
    <canvas id="moodChart" height="220"></canvas>
    <div id="moodTags" style="margin-top:8px;color:#bcd0e6;font-size:.9rem"></div>
  </div>
</div>

<!-- å†ç”Ÿç”¨ï¼ˆhiddenï¼‰ -->
<audio id="ttsAudio" preload="auto"></audio>

<script>
// ======= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ =======
const KEY = "mirror_diary_v2"; // { [date]: { logs: string[], summary?: string, mood?: {score,tags[]} } }
const today = () => new Date().toISOString().slice(0,10);
const load = () => JSON.parse(localStorage.getItem(KEY) || "{}");
const save = (obj) => localStorage.setItem(KEY, JSON.stringify(obj));
const pushLog = (date, text) => {
  const db = load();
  if(!db[date]) db[date] = { logs: [] };
  db[date].logs.push(text);
  save(db);
};
const setSummary = (date, summary) => {
  const db = load();
  if(!db[date]) db[date] = { logs: [] };
  db[date].summary = summary;
  save(db);
};
const setMood = (date, score, tags) => {
  const db = load();
  if(!db[date]) db[date] = { logs: [] };
  db[date].mood = { score, tags };
  save(db);
};

// ======= UIå‚ç…§ =======
const userInput   = document.getElementById("userInput");
const reflectBtn  = document.getElementById("reflectBtn");
const summarizeBtn= document.getElementById("summarizeBtn");
const readBtn     = document.getElementById("readBtn");
const result      = document.getElementById("result");
const entriesEl   = document.getElementById("entries");
const moodCanvas  = document.getElementById("moodChart");
const moodTagsEl  = document.getElementById("moodTags");
const ttsAudio    = document.getElementById("ttsAudio");

// ======= è¡¨ç¤ºï¼†æç”» =======
function renderDiary(){
  const db = load();
  entriesEl.innerHTML = "";
  Object.keys(db).sort().reverse().forEach(date=>{
    const d = db[date];
    const div=document.createElement("div");
    div.className="entry";
    const sum = d.summary ? `<div class="summaryBox">ğŸ§  ä»Šæ—¥ã®ã¾ã¨ã‚ï¼š${escapeHtml(d.summary)}</div>` : "";
    div.innerHTML = `
      <div class="entry-date">${date}</div>
      <div class="entry-text">${escapeHtml((d.logs||[]).join("\n\n"))}</div>
      ${sum}
    `;
    entriesEl.appendChild(div);
  });
}

let chart;
function renderChart(){
  const db = load();
  const dates = Object.keys(db).sort().slice(-7); // ç›´è¿‘7æ—¥
  const data  = dates.map(d => (db[d].mood && db[d].mood.score) ? db[d].mood.score : null);
  if(chart){ chart.destroy(); }
  chart = new Chart(moodCanvas.getContext("2d"), {
    type: "line",
    data: {
      labels: dates,
      datasets: [{
        label: "mood score",
        data,
        tension: 0.35,
        fill: false
      }]
    },
    options: {
      plugins:{ legend: { display:false } },
      scales: {
        y: { min: 0, max: 100, ticks: { stepSize: 20 } }
      }
    }
  });
  // æœ€æ–°æ—¥ã®ã‚¿ã‚°è¡¨ç¤º
  const last = dates[dates.length-1];
  if(last && db[last].mood && db[last].mood.tags){
    moodTagsEl.textContent = `ãã‚‡ã†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${db[last].mood.tags.join(" / ")}`;
  }else{
    moodTagsEl.textContent = "";
  }
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

// ======= ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæ•°å­—/ãƒ©ãƒ™ãƒ«/è¨˜å·ï¼‰ =======
function cleanLine(t){
  if(!t) return "";
  t = t.replace(/^\s*(?:\(?\s*[\dï¼-ï¼™]+\s*\)?[\.ï¼\)]\s*)/gm, "");
  t = t.replace(/^(è¦ç´„|åŠ©è¨€|æ¬¡ã®ä¸€è¨€|ã‚«ãƒ†ã‚´ãƒª)\s*[:ï¼š]\s*/gm, "");
  t = t.replace(/[ğŸ’¡â­ï¸âœ¨ğŸ”¥âœ…â–¶ï¸â¤â†’â€¢â—â—†â– â—‰â€»â˜…â˜†â—â—‹â—â–²â–³â– â–¡â—†â—‡]/g, "");
  return t.trim();
}

// ======= ãƒœã‚¿ãƒ³å‹•ä½œ =======
reflectBtn.onclick = async () => {
  const text = userInput.value.trim();
  if(!text) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
  result.textContent = "è€ƒãˆã¦ã„ã¾ã™â€¦";
  const r = await fetch("/reflect", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ user_input: text })
  });
  const data = await r.json();
  if(!data.reply){ result.textContent = "ã‚¨ãƒ©ãƒ¼"; return; }
  const {summary,advice,next} = data.reply;
  const msg = `${summary}\n${advice}\n${next}`;
  result.textContent = msg;
  pushLog(today(), msg);
  userInput.value = "";
  renderDiary();
};

summarizeBtn.onclick = async () => {
  const db = load();
  const date = today();
  const items = (db[date]?.logs || []);
  if(items.length === 0) return alert("ä»Šæ—¥ã®ReflectãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
  result.textContent = "AIãŒã¾ã¨ã‚ã¦ã„ã¾ã™â€¦";
  // è¦ç´„
  const s = await fetch("/summarize", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ items })
  }).then(r=>r.json());
  if(s.summary){
    setSummary(date, cleanLine(s.summary));
  }
  // æ„Ÿæƒ…ã‚¹ã‚³ã‚¢
  const a = await fetch("/analyze", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ items })
  }).then(r=>r.json());
  if(typeof a.mood_score === "number"){
    setMood(date, a.mood_score, a.tags || []);
  }
  renderDiary();
  renderChart();
  // ã¾ã¨ã‚ã‚’ç”»é¢ä¸‹ã«ã‚‚è¡¨ç¤º
  if(s.summary){
    const box = document.createElement("div");
    box.className = "summaryBox";
    box.textContent = "ğŸ§  ä»Šæ—¥ã®ã¾ã¨ã‚ï¼š" + s.summary;
    result.appendChild(box);
  }
};

readBtn.onclick = async () => {
  // ä»Šæ—¥ã®ã¾ã¨ã‚ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ç›´è¿‘ã®ãƒ­ã‚°ã‚’èª­ã‚€
  const db = load();
  const date = today();
  let text = (db[date]?.summary || "");
  if(!text){
    const logs = db[date]?.logs || [];
    if(logs.length === 0) return alert("èª­ã¿ä¸Šã’ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšReflectã—ã¦ãã ã•ã„ã€‚");
    text = logs[logs.length-1]; // ç›´è¿‘
  }
  const payload = { text, voice: "alloy" }; // è‹¥ã‚è‡ªç„¶ç³»ã€‚haru/verseç­‰ã«å¤‰æ›´å¯
  const resp = await fetch("/tts", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  if(!resp.ok){
    return alert("éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼");
  }
  const blob = await resp.blob();
  const url = URL.createObjectURL(blob);
  ttsAudio.src = url;
  ttsAudio.play();
};

// åˆæœŸæç”»
renderDiary();
renderChart();
</script>
</body>
</html>
