<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mirror Loop v0.3.5</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  font-family:'Noto Sans JP',sans-serif;
  background: radial-gradient(circle at 20% 30%, #081221, #0f2027, #203a43, #2c5364);
  color:#fff;
  overflow-x:hidden;
}
.container {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; min-height:100vh;
  padding:20px;
}
.glass-box {
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;
  padding:40px 25px;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
  backdrop-filter:blur(12px);
  width:100%; max-width:600px;
  animation:fadeIn 1.2s ease;
}
@keyframes fadeIn {
  from {opacity:0; transform:translateY(30px);}
  to {opacity:1; transform:translateY(0);}
}
h1 {
  font-weight:700; font-size:1.8em;
  text-align:center;
  background:linear-gradient(90deg,#00c6ff,#0072ff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:12px;
}
input {
  width:100%; padding:12px; border:none; border-radius:10px;
  margin-bottom:14px;
  font-size:1em;
  background:rgba(255,255,255,0.12);
  color:#fff;
}
button {
  margin:6px; padding:12px 18px; border:none;
  border-radius:10px;
  background:linear-gradient(90deg,#00c6ff,#0072ff);
  color:#fff; font-weight:600;
  cursor:pointer;
  transition:0.2s;
}
button:hover {
  transform:scale(1.05);
  background:linear-gradient(90deg,#92fe9d,#00c9ff);
  color:#111;
}
.box {
  background:rgba(255,255,255,0.08);
  border-radius:12px;
  padding:16px;
  margin-top:16px;
  line-height:1.6;
}
a { color:#00c9ff; text-decoration:none; }
canvas { margin-top:24px; width:100%; max-width:520px; }
pre { white-space:pre-wrap; word-break:break-word; }
</style>
</head>
<body>
  <div class="container">
    <div class="glass-box">
      <h1>ğŸ’ Mirror Loop v0.3.5</h1>
      <p style="text-align:center;">æ¯æ—¥Reflect â†’ 1é€±é–“ã”ã¨ã«AIãŒâ€œå¿ƒã®é€±å ±â€ã‚’ç”Ÿæˆã—ã¾ã™</p>
      <input id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ">
      <div style="text-align:center;">
        <button onclick="reflect()">ğŸ’­ Reflect</button>
        <button onclick="makeWeekly()">ğŸ“… é€±å ±ã‚’ä½œæˆ</button>
      </div>

      <div id="result" class="box"></div>
      <canvas id="emotionChart"></canvas>

      <div id="weekly" class="box" style="display:none;">
        <h3>ğŸ“Š ä»Šé€±ã®AIãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <div id="weeklyStats"></div>
        <pre id="weeklyComment"></pre>
        <div id="weeklyAd"></div>
      </div>
    </div>
  </div>

<script>
const user_id = "guest";

async function reflect(){
  const message = document.getElementById("userInput").value;
  const res = await fetch("/reflect", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message,user_id})
  });
  const data = await res.json();
  document.getElementById("result").innerHTML =
    `ğŸ’­ æ„Ÿæƒ…ï¼š${data.emotion}ï¼ˆã‚¹ã‚³ã‚¢:${data.score}ï¼‰<br>`+
    `ğŸ’¡ ${data.advice}<br>`+
    `ğŸ”— <a href="${getAdUrl(data.category)}" target="_blank">é–¢é€£å•†å“ã‚’è¦‹ã‚‹</a>`;
  await drawChart();
}

async function makeWeekly(){
  const res = await fetch("/weekly_report/"+user_id);
  const payload = await res.json();
  if(payload.error){ alert(payload.error); return; }
  const s = payload.summary;
  document.getElementById("weeklyStats").textContent =
    `å¹³å‡ã‚¹ã‚³ã‚¢ï¼š${s.avg}ã€€æœ€å¤§ï¼š${s.max}ã€€æœ€å°ï¼š${s.min}ã€€å‚¾å‘ï¼š${s.trend}ã€€ä¸»è¦ã‚«ãƒ†ã‚´ãƒªï¼š${s.top_category}`;
  document.getElementById("weeklyComment").textContent = payload.comment;
  document.getElementById("weeklyAd").innerHTML =
    `ğŸ›’ ãŠã™ã™ã‚ï¼š<a href="${payload.ad_url}" target="_blank">${payload.ad_url}</a>`;
  document.getElementById("weekly").style.display = "block";
}

async function drawChart(){
  const res = await fetch("/history/"+user_id);
  const data = await res.json();
  const labels = data.map(d => d[0]);
  const scores = data.map(d => d[1]);
  const ctx = document.getElementById('emotionChart').getContext('2d');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label:'æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆéå»7æ—¥ï¼‰',
        data:scores,
        borderColor:'#00c9ff',
        backgroundColor:'rgba(0,201,255,0.2)',
        fill:true, tension:0.35, pointRadius:4
      }]
    },
    options:{
      scales:{ y:{min:0,max:100,ticks:{color:'#fff'}},x:{ticks:{color:'#fff'}}},
      plugins:{ legend:{labels:{color:'#fff'}} }
    }
  });
}

function getAdUrl(category){
  const links = {
    healing:"https://www.amazon.co.jp/s?k=%E7%99%92%E3%81%97",
    learning:"https://www.amazon.co.jp/s?k=%E8%B3%87%E6%A0%BC",
    action:"https://www.amazon.co.jp/s?k=%E3%82%AC%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88",
    creative:"https://www.amazon.co.jp/s?k=AI+%E3%82%A2%E3%83%BC%E3%83%88"
  };
  return links[category] || links["healing"];
}
drawChart();
</script>
</body>
</html>
