<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mirror Loop v0.3.5</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg1:#081221; --bg2:#0f2027; --bg3:#203a43; --bg4:#2c5364;
  --text:#ffffff; --muted:#c9d1d9;
  --card-bg:rgba(255,255,255,0.08);
  --card-border:rgba(255,255,255,0.12);
  --accent1:#00c6ff; --accent2:#0072ff;
  --shadow:0 8px 24px rgba(0,0,0,0.35);
}
:root[data-theme="light"]{
  --bg1:#e6f1ff; --bg2:#f7fbff; --bg3:#eef6ff; --bg4:#e6f1ff;
  --text:#0b1220; --muted:#475569;
  --card-bg:rgba(255,255,255,0.7);
  --card-border:rgba(0,0,0,0.08);
  --accent1:#3b82f6; --accent2:#06b6d4;
  --shadow:0 8px 24px rgba(0,0,0,0.10);
}

/* èƒŒæ™¯ã®â€œå‘¼å¸æ„Ÿâ€ã‚¢ãƒ‹ãƒ¡ */
body{
  margin:0; font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--text); overflow-x:hidden;
  background: radial-gradient(circle at 15% 20%, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
  background-size: 200% 200%;
  animation: breathe 18s ease-in-out infinite;
}
@keyframes breathe{
  0%{ background-position:0% 0% }
  50%{ background-position:100% 100% }
  100%{ background-position:0% 0% }
}

.container{
  min-height:100svh; display:flex; align-items:center; justify-content:center; padding:24px;
}
.card{
  width:min(680px, 95%); padding:32px 24px; border-radius:20px;
  background:var(--card-bg); border:1px solid var(--card-border); backdrop-filter:blur(12px);
  box-shadow:var(--shadow); animation:fadeIn .8s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

.header{
  display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;
}
h1{
  margin:0; font-size:1.8rem; font-weight:800;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  letter-spacing:.2px;
}
.subtitle{margin:6px 0 18px; color:var(--muted); text-align:left;}

.input{
  width:100%; padding:12px 14px; border:none; border-radius:12px;
  background:rgba(255,255,255,0.12); color:var(--text); font-size:1rem; outline:none;
}
:root[data-theme="light"] .input{ background:rgba(0,0,0,0.05); }

.btns{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 6px; }

/* æ³¢ç´‹ãƒœã‚¿ãƒ³ */
.btn{
  position:relative; overflow:hidden;
  padding:12px 18px; border:none; border-radius:12px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#fff; font-weight:700; cursor:pointer; transition:transform .15s ease;
}
.btn.secondary{
  background:transparent; color:var(--text);
  border:1px solid var(--card-border);
}
.btn:active{ transform:scale(.98) }
/* ripple element */
.btn .ripple{
  position:absolute; border-radius:50%; transform:scale(0);
  background:rgba(255,255,255,.45); pointer-events:none;
  animation:ripple .6s linear;
}
@keyframes ripple{ to{ transform:scale(12); opacity:0 } }

.box{
  margin-top:14px; padding:16px; border-radius:12px;
  background:var(--card-bg); border:1px solid var(--card-border);
}
a{ color:var(--accent1); text-decoration:none }
canvas{ margin-top:18px; width:100% !important; max-height:260px }
pre{ white-space:pre-wrap; word-break:break-word }

/* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ï¼ˆå³ä¸Šï¼‰ */
.toggle{
  display:inline-flex; align-items:center; gap:8px; user-select:none; font-size:.9rem; color:var(--muted);
}
.switch{
  --w:46px; --h:26px;
  width:var(--w); height:var(--h); border-radius:999px; position:relative;
  background:rgba(255,255,255,.2); border:1px solid var(--card-border);
}
.switch input{ display:none }
.knob{
  position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
  background:#fff; transition:left .18s ease;
}
input:checked + .knob{ left:22px }

.footer{ margin-top:10px; font-size:.85rem; color:var(--muted); text-align:center }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>ğŸ’ Mirror Loop v0.3.5</h1>
        <label class="toggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
          <span>Light</span>
          <div class="switch">
            <input id="themeCheck" type="checkbox" />
            <span class="knob"></span>
          </div>
          <span>Dark</span>
        </label>
      </div>
      <p class="subtitle">æ¯æ—¥Reflect â†’ 1é€±é–“ã”ã¨ã«AIãŒâ€œå¿ƒã®é€±å ±â€ã‚’ç”Ÿæˆã—ã¾ã™</p>

      <input id="userInput" class="input" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ">

      <div class="btns">
        <button class="btn" id="reflectBtn">ğŸ’­ Reflect</button>
        <button class="btn secondary" id="weeklyBtn">ğŸ“… é€±å ±ã‚’ä½œæˆ</button>
      </div>

      <div id="result" class="box"></div>
      <canvas id="emotionChart"></canvas>

      <div id="weekly" class="box" style="display:none;">
        <h3 style="margin:0 0 8px">ğŸ“Š ä»Šé€±ã®AIãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <div id="weeklyStats"></div>
        <pre id="weeklyComment" style="margin:8px 0 0"></pre>
        <div id="weeklyAd" style="margin-top:8px"></div>
      </div>

      <div class="footer">Â© Mirror Loop</div>
    </div>
  </div>

<script>
const user_id = "guest";

/* ============ Ripple ============ */
function addRipple(e){
  const btn = e.currentTarget;
  const old = btn.querySelector('.ripple');
  if(old) old.remove();
  const circle = document.createElement('span');
  const d = Math.max(btn.clientWidth, btn.clientHeight);
  circle.style.width = circle.style.height = d + 'px';
  const rect = btn.getBoundingClientRect();
  circle.style.left = (e.clientX - rect.left - d/2) + 'px';
  circle.style.top  = (e.clientY - rect.top  - d/2) + 'px';
  circle.className = 'ripple';
  btn.appendChild(circle);
}

/* ============ Theme toggle ============ */
const root = document.documentElement;
const themeCheck = document.getElementById('themeCheck');
(function initTheme(){
  const saved = localStorage.getItem('ml-theme') || 'dark';
  root.setAttribute('data-theme', saved);
  themeCheck.checked = (saved === 'dark');
})();
themeCheck.addEventListener('change', ()=>{
  const mode = themeCheck.checked ? 'dark' : 'light';
  root.setAttribute('data-theme', mode);
  localStorage.setItem('ml-theme', mode);
  // ç›®ç››ã®è‰²ã‚’å†é©ç”¨
  if(window._chart){
    const color = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#fff';
    window._chart.options.scales.y.ticks.color = color;
    window._chart.options.scales.x.ticks.color = color;
    window._chart.options.plugins.legend.labels.color = color;
    window._chart.update();
  }
});

/* ============ API calls ============ */
async function reflect(){
  const message = document.getElementById("userInput").value;
  const res = await fetch("/reflect", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message,user_id})
  });
  const data = await res.json();
  document.getElementById("result").innerHTML =
    `ğŸ’­ æ„Ÿæƒ…ï¼š${data.emotion}ï¼ˆã‚¹ã‚³ã‚¢:${data.score}ï¼‰<br>`+
    `ğŸ’¡ ${data.advice}<br>`+
    `ğŸ”— <a href="${getAdUrl(data.category)}" target="_blank" rel="noopener">é–¢é€£å•†å“ã‚’è¦‹ã‚‹</a>`;
  await drawChart();
}

async function makeWeekly(){
  const res = await fetch("/weekly_report/"+user_id);
  const payload = await res.json();
  if(payload.error){ alert(payload.error); return; }
  const s = payload.summary;
  document.getElementById("weeklyStats").textContent =
    `å¹³å‡ã‚¹ã‚³ã‚¢ï¼š${s.avg}ã€€æœ€å¤§ï¼š${s.max}ã€€æœ€å°ï¼š${s.min}ã€€å‚¾å‘ï¼š${s.trend}ã€€ä¸»è¦ã‚«ãƒ†ã‚´ãƒªï¼š${s.top_category}`;
  document.getElementById("weeklyComment").textContent = payload.comment;
  document.getElementById("weeklyAd").innerHTML =
    `ğŸ›’ ãŠã™ã™ã‚ï¼š<a href="${payload.ad_url}" target="_blank" rel="noopener">${payload.ad_url}</a>`;
  document.getElementById("weekly").style.display = "block";
}

async function drawChart(){
  const res = await fetch("/history/"+user_id);
  const data = await res.json();
  const labels = data.map(d => d[0]);
  const scores = data.map(d => d[1]);
  const ctx = document.getElementById('emotionChart').getContext('2d');
  if(window._chart) window._chart.destroy();
  const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#fff';
  window._chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label:'æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆéå»7æ—¥ï¼‰',
        data:scores,
        borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent1').trim() || '#00c9ff',
        backgroundColor:'rgba(0,201,255,0.18)',
        fill:true, tension:0.35, pointRadius:4
      }]
    },
    options:{
      scales:{ y:{min:0,max:100,ticks:{color:tickColor}}, x:{ticks:{color:tickColor}} },
      plugins:{ legend:{ labels:{ color:tickColor } } },
      animation:{ duration:600 }
    }
  });
}

function getAdUrl(category){
  const links = {
    healing:"https://www.amazon.co.jp/s?k=%E7%99%92%E3%81%97",
    learning:"https://www.amazon.co.jp/s?k=%E8%B3%87%E6%A0%BC",
    action:"https://www.amazon.co.jp/s?k=%E3%82%AC%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88",
    creative:"https://www.amazon.co.jp/s?k=AI+%E3%82%A2%E3%83%BC%E3%83%88"
  };
  return links[category] || links["healing"];
}

/* ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸ */
document.getElementById('reflectBtn').addEventListener('click', (e)=>{ addRipple(e); reflect(); });
document.getElementById('weeklyBtn').addEventListener('click', (e)=>{ addRipple(e); makeWeekly(); });

/* åˆæœŸæç”» */
drawChart();
</script>
</body>
</html>
