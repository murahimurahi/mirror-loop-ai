<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’ Mirror Loop v0.3.6</title>
<style>
:root {
  --bg-dark: linear-gradient(135deg,#0e1a24,#192a3a);
  --bg-light: linear-gradient(135deg,#e8f4ff,#ffffff);
  --txt-dark: #eaf6ff;
  --txt-light: #20242b;
  --accent: #00b3ff;
}
body {
  margin: 0; padding: 0;
  font-family: "Segoe UI", sans-serif;
  transition: background 0.5s, color 0.5s;
  display: flex; justify-content: center; align-items: center;
  height: 100vh;
  background: var(--bg-dark);
  color: var(--txt-dark);
  overflow: hidden;
}
body.light {
  background: var(--bg-light);
  color: var(--txt-light);
}
.animated-bg {
  position: absolute;
  width: 400%;
  height: 400%;
  background: radial-gradient(circle at 20% 20%, rgba(0,255,255,0.08), transparent 70%),
              radial-gradient(circle at 80% 80%, rgba(255,0,255,0.08), transparent 70%);
  animation: moveBg 30s linear infinite;
  z-index: -1;
}
@keyframes moveBg {
  from { transform: translate(0,0); }
  to { transform: translate(-50%, -50%); }
}
.container {
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.06);
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  width: 90%; max-width: 480px;
  box-shadow: 0 0 25px rgba(0,0,0,0.25);
}
h2 { margin-top: 0; }
input {
  width: 85%; padding: 12px; border-radius: 8px;
  border: none; background: rgba(0,0,0,0.2);
  color: #fff; font-size: 1rem;
}
body.light input { background: rgba(200,200,200,0.4); color: #000; }
button {
  margin: 8px; padding: 10px 20px;
  border: none; border-radius: 8px;
  color: white; background: var(--accent);
  cursor: pointer;
  box-shadow: 0 0 8px var(--accent);
  transition: 0.25s;
}
button:hover { box-shadow: 0 0 20px var(--accent); transform: scale(1.05); }
.toggle {
  position: absolute; top: 15px; right: 20px;
  background: none; border: 1px solid var(--accent);
  border-radius: 50%; width: 38px; height: 38px;
  color: var(--accent); cursor: pointer;
}
#resultBox { margin-top: 20px; }
canvas { width: 100%; height: 240px; margin-top: 20px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="animated-bg"></div>
<button class="toggle" id="modeBtn">â˜€ï¸</button>
<div class="container">
  <h2>ğŸ’ Mirror Loop v0.3.6</h2>
  <p>æ¯æ—¥ã®ãƒªãƒ•ãƒ¬ã‚¯ãƒˆã‚’AIãŒè§£æã—ã€ã‚ãªãŸã®å¿ƒã‚’å¯è¦–åŒ–ã—ã¾ã™</p>
  <input id="userInput" placeholder="ä»Šæ—¥ã¯ã©ã‚“ãªæ°—åˆ†ã§ã—ãŸã‹ï¼Ÿ">
  <div>
    <button id="reflectBtn">Reflect</button>
    <button id="weekBtn">é€±å ±ã‚’è¦‹ã‚‹</button>
  </div>
  <div id="resultBox"></div>
  <canvas id="chart"></canvas>
</div>

<script>
const ctx = document.getElementById('chart').getContext('2d');
let chart;

// ------------------ Reflectæ©Ÿèƒ½ ------------------
async function reflect() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

  const res = await fetch("/reflect", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ message: msg, user_id: "guest" })
  });
  const data = await res.json();

  document.getElementById("resultBox").innerHTML = `
    <p>æ„Ÿæƒ…ï¼š${data.emotion}</p>
    <p>ã‚¹ã‚³ã‚¢ï¼š${data.score}</p>
    <p>ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š${data.advice}</p>
    <p>æ¬¡ã®è³ªå•ï¼š${data.followup}</p>
  `;
  input.value = ""; // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
}

// ------------------ é€±å ± ------------------
async function makeWeekly() {
  const res = await fetch("/weekly_report?user_id=guest");
  const data = await res.json();
  if (!data.summary) {
    document.getElementById("resultBox").innerHTML = `<p>${data.comment}</p>`;
    return;
  }
  document.getElementById("resultBox").innerHTML = `
    <h3>ä»Šé€±ã®ã¾ã¨ã‚</h3>
    <p>${data.comment}</p>
    <p>å¹³å‡ã‚¹ã‚³ã‚¢: ${data.summary.å¹³å‡ã‚¹ã‚³ã‚¢}</p>`;
}

// ------------------ ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆåˆ‡æ›¿ ------------------
const body = document.body;
const modeBtn = document.getElementById('modeBtn');
if (localStorage.getItem("theme") === "light") {
  body.classList.add("light");
  modeBtn.textContent = "ğŸŒ™";
}
modeBtn.onclick = () => {
  body.classList.toggle("light");
  const light = body.classList.contains("light");
  modeBtn.textContent = light ? "ğŸŒ™" : "â˜€ï¸";
  localStorage.setItem("theme", light ? "light" : "dark");
};

// ------------------ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ------------------
document.getElementById('reflectBtn').onclick = reflect;
document.getElementById('weekBtn').onclick = makeWeekly;
document.getElementById('userInput').addEventListener("keydown", e=>{
  if(e.key==="Enter") reflect();
});
</script>
</body>
</html>
