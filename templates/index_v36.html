<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mirror Loop v0.3.6</title>
<style>
  :root { --panel: rgba(255,255,255,.06); }

  html,body{height:100%}
  body{
    margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
    background:
      radial-gradient(1200px 1200px at 50% 40%, #1b2545, #0f1325 60%, #0a0c18 100%);
    background-size:102% 102%;
    animation: breathe 10s ease-in-out infinite;
    display:flex; align-items:center; justify-content:center;
    color:#eaf1ff;
  }
  @keyframes breathe{
    0%,100%{ filter:brightness(1); background-size:102% 102%;}
    50%   { filter:brightness(1.08); background-size:106% 106%;}
  }

  .card{
    width:min(520px, 92vw);
    background:var(--panel); backdrop-filter: blur(10px);
    border-radius:20px; padding:24px 22px; box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  h1{margin:0 0 10px; font-weight:700; font-size:22px}
  .muted{opacity:.72; font-size:13px; margin-bottom:12px}

  textarea{
    width:100%; height:110px; border:none; outline:0;
    border-radius:12px; padding:12px 14px; resize:none;
    background: rgba(255,255,255,.08); color:#fff; font-size:15px;
  }

  .row{display:flex; gap:10px; margin-top:12px}
  button{
    flex:1; border:0; border-radius:999px; padding:11px 14px; cursor:pointer;
    color:#fff; font-weight:600; letter-spacing:.2px;
    background:linear-gradient(135deg,#0a84ff,#34c8ff);
    transition:transform .15s ease, box-shadow .15s ease, opacity .15s ease;
  }
  button.secondary{background:linear-gradient(135deg,#5b5f72,#7a819b)}
  button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,170,255,.25);}
  button:active{ transform:translateY(0); opacity:.92;}

  .out{margin-top:14px; background:rgba(255,255,255,.08); border-radius:12px; padding:12px; font-size:14px}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ’ Mirror Loop v0.3.6</h1>
    <p class="muted">æ¯æ—¥ã²ã¨ã“ã¨è¨˜éŒ²ã€‚å…¥åŠ›ã™ã‚‹ã¨AIãŒè¦ç´„ã¨åŠ©è¨€ã‚’è¿”ã—ã¾ã™ã€‚</p>

    <textarea id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸã€‚"></textarea>

    <div class="row">
      <button id="reflectBtn">Reflect</button>
      <button id="weeklyBtn" class="secondary">é€±å ±ã‚’ä½œæˆ</button>
    </div>

    <div id="output" class="out">æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆé€²è¡Œä¸­ï¼‰</div>
  </div>

<script>
  // å…¥åŠ›ã‚’å§‹ã‚ãŸã‚‰ä¾‹æ–‡ã¯æ¶ˆã™ï¼ˆæœªå…¥åŠ›ã§é›¢ã‚ŒãŸã‚‰å¾©æ´»ï¼‰
  const input = document.getElementById('userInput');
  input.addEventListener('focus', ()=> input.placeholder = '');
  input.addEventListener('blur', ()=> {
    if(!input.value.trim()) input.placeholder = 'ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸã€‚';
  });

  // /reflect å‘¼ã³å‡ºã—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
  async function reflect() {
    const val = input.value.trim();
    if(!val){ alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const out = document.getElementById('output');
    out.textContent = 'AIãŒè€ƒãˆã¦ã„ã¾ã™â€¦';

    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 25_000); // 25ç§’ã§æ‰“ã¡åˆ‡ã‚Š

    try{
      const res = await fetch('/reflect', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_input: val }),
        signal: ctrl.signal
      });

      if(!res.ok){
        const text = await res.text();
        out.textContent = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status}) / ${text.slice(0,120)}â€¦`;
        return;
      }
      const data = await res.json();
      if(data.error){
        out.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
        return;
      }
      out.innerHTML = `
        <b>è¦ç´„</b>ï¼š${data.summary}<br>
        <b>åŠ©è¨€</b>ï¼š${(data.advice||[]).join(' / ')}<br>
        <b>ã‚«ãƒ†ã‚´ãƒª</b>ï¼š${data.category}ã€€<b>ã‚¹ã‚³ã‚¢</b>ï¼š${data.score}<br>
        <b>æ¬¡ã®è³ªå•</b>ï¼š${data.followup}
      `;
    }catch(e){
      out.textContent = (e.name==='AbortError') ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”ãªã—ï¼‰' : `é€šä¿¡å¤±æ•—: ${e}`;
    }finally{
      clearTimeout(t);
    }
  }

  // /weekly_report ã¯å¾Œã§DBé€£æºã™ã‚‹ã®ã§ä»Šã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
  async function weekly(){
    const out = document.getElementById('output');
    out.textContent = 'é€±å ±ç”Ÿæˆä¸­â€¦';
    try{
      const r = await fetch('/weekly_report',{method:'POST'});
      const j = await r.json();
      out.textContent = j.report || 'æº–å‚™ä¸­';
    }catch(e){ out.textContent = 'é€±å ±ã®ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼'; }
  }

  document.getElementById('reflectBtn').onclick = reflect;
  document.getElementById('weeklyBtn').onclick  = weekly;
</script>
</body>
</html>
