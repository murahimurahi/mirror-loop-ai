<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mirror Loop v0.3.6</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --fg:#e5e7eb; --muted:#94a3b8;
      --accent:#22d3ee; --accent2:#60a5fa; --card:#0b1220; --ok:#34d399; --warn:#f59e0b;
    }
    [data-theme="light"]{
      --bg1:#f8fafc; --bg2:#eef2ff; --fg:#0f172a; --muted:#475569;
      --accent:#0284c7; --accent2:#7c3aed; --card:#ffffff; --ok:#059669; --warn:#b45309;
    }

    /* ===== èƒŒæ™¯ï¼šã‚†ã£ãã‚Šå‹•ãï¼‹å‘¼å¸æ„Ÿ ===== */
    body{
      margin:0; min-height:100dvh; color:var(--fg);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(96,165,250,.12), transparent 70%),
        radial-gradient(900px 480px at 90% 20%, rgba(34,211,238,.12), transparent 70%),
        radial-gradient(900px 520px at 30% 90%, rgba(124,58,237,.10), transparent 70%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      background-size: 140% 140%;
      animation: bgMove 36s ease-in-out infinite alternate,
                 breathe 10s ease-in-out infinite; /* â† å‘¼å¸æ„Ÿ */
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    /* èƒŒæ™¯ã®ä½ç½®ã‚’ã‚†ã£ãã‚Šç§»å‹• */
    @keyframes bgMove{
      0%{   background-position: 0% 40%, 100% 10%, 40% 100%, 0 0; }
      100%{ background-position: 60% 0%,  40% 60%, 80% 20%, 100% 100%; }
    }
    /* æ˜ã‚‹ã•/å½©åº¦ã‚’å¾®å°ã«ä¸Šä¸‹ã—ã¦â€œå‘¼å¸â€ã‚’è¡¨ç¾ */
    @keyframes breathe{
      0%,100%{ filter: brightness(1.00) saturate(1.00); }
      50%    { filter: brightness(1.06) saturate(1.08); }
    }

    .wrap{max-width:980px;margin:0 auto;padding:28px;}
    .card{
      background: color-mix(in oklab, var(--card) 88%, transparent);
      border:1px solid color-mix(in oklab, var(--fg) 10%, transparent);
      backdrop-filter: blur(6px);
      border-radius:18px; padding:22px 22px 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
    }
    h1{font-size: clamp(22px, 2.6vw, 28px); margin:4px 0 16px; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:14px; margin-bottom:18px}

    .row{display:flex; gap:12px; align-items:center}
    .row.stretch{align-items:stretch}
    .grow{flex:1}

    textarea{
      width:100%; min-height:72px; resize:vertical;
      color:var(--fg); background:transparent;
      border:1px solid color-mix(in oklab, var(--fg) 12%, transparent);
      border-radius:14px; padding:14px 14px 12px; outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    textarea:focus{
      border-color: color-mix(in oklab, var(--accent) 70%, var(--fg) 30%);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
    }

    /* ===== ãƒœã‚¿ãƒ³ï¼‹æ³¢ç´‹ï¼ˆrippleï¼‰ ===== */
    .btn{
      position:relative; border:none; cursor:pointer; user-select:none;
      color:#0b1220; font-weight:700; letter-spacing:.2px;
      padding:12px 16px; border-radius:12px; min-width:116px;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      transition: transform .06s ease, filter .2s ease, box-shadow .2s ease;
      box-shadow: 0 10px 28px color-mix(in oklab, var(--accent) 35%, transparent);
      overflow:hidden; /* â† æ³¢ç´‹ã‚’ãƒœã‚¿ãƒ³å†…ã«é–‰ã˜è¾¼ã‚ã‚‹ */
      isolation:isolate;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    /* ãµã‚ã£ã¨å…‰ã‚‹å¤–å‘¨ */
    .btn::after{
      content:""; position:absolute; inset:-2px; border-radius:14px; z-index:-1;
      background: radial-gradient(400px 120px at 50% -10%, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%),
                  radial-gradient(280px 120px at 50% 120%, color-mix(in oklab, var(--accent2) 45%, transparent), transparent 60%);
      filter: blur(14px); opacity:.55; transition:opacity .2s ease;
    }
    .btn:hover::after{ opacity:.9; }

    .btn.secondary{
      color:var(--fg); background: linear-gradient(180deg, color-mix(in oklab, var(--fg) 10%, transparent), color-mix(in oklab, var(--fg) 18%, transparent));
      box-shadow:none; border:1px solid color-mix(in oklab, var(--fg) 14%, transparent);
    }

    /* æ³¢ç´‹è¦ç´ ï¼ˆJSã§å‹•çš„ã«è¿½åŠ ï¼‰ */
    .ripple{
      position:absolute; border-radius:50%;
      transform: translate(-50%, -50%); pointer-events:none;
      width:12px; height:12px; background: rgba(255,255,255,.55);
      mix-blend-mode: screen; filter: blur(0.5px);
      animation: ripple 600ms ease-out forwards;
    }
    @keyframes ripple{
      0%   { opacity:.35; transform:translate(-50%,-50%) scale(.1); }
      70%  { opacity:.20; }
      100% { opacity:0;   transform:translate(-50%,-50%) scale(18); }
    }

    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px}
    .switch{display:inline-flex; gap:10px; align-items:center; cursor:pointer; user-select:none; font-size:14px; color:var(--muted);}
    .toggle{width:46px; height:26px; border-radius:20px; background: color-mix(in oklab, var(--fg) 14%, transparent); position:relative; transition:background .2s ease;}
    .toggle::after{content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:#fff; transition:left .22s ease, background .2s ease; box-shadow:0 2px 6px rgba(0,0,0,.25);}
    [data-theme="light"] .toggle::after{ background:#111827 }
    .toggle.on{ background: color-mix(in oklab, var(--accent) 70%, var(--fg) 30%); }
    .toggle.on::after{ left:23px }

    .log{margin-top:14px; padding:14px; border-radius:12px; background: color-mix(in oklab, var(--card) 88%, transparent); border:1px solid color-mix(in oklab, var(--fg) 10%, transparent); max-height:52dvh; overflow:auto; white-space:pre-wrap; line-height:1.65;}
    .kpi{display:flex; gap:12px; align-items:center; margin:10px 0 2px; font-size:13px; color:var(--muted)}
    .bar{height:10px; width:100%; background: color-mix(in oklab, var(--fg) 10%, transparent); border-radius:999px; overflow:hidden}
    .bar>i{display:block; height:100%; width:18%; background:linear-gradient(90deg, var(--ok), var(--accent));}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>
        <h1>ğŸ’ Mirror Loop v0.3.6</h1>
        <div class="sub">æ¯æ—¥Reflect â†’ é€±1ã§AIãŒâ€œæ¬¡ã®ä¸€é€±é–“ã®è¨­è¨ˆâ€ã‚’ææ¡ˆã—ã¾ã™ã€‚</div>
      </div>
      <label class="switch" id="themeSwitch">
        <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
        <div class="toggle" id="toggle"></div>
      </label>
    </div>

    <div class="card">
      <div class="row stretch">
        <div class="grow">
          <textarea id="userInput" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸã€‚"></textarea>
          <div class="hint">Enterã§é€ä¿¡ï¼ˆCtrl+Enterã¯æ”¹è¡Œï¼‰ã€‚é€ä¿¡å¾Œã¯å…¥åŠ›æ¬„ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚</div>
        </div>
        <div class="col">
          <div class="row" style="flex-direction:column;gap:10px;">
            <button id="reflectBtn" class="btn">Reflect</button>
            <button id="weeklyBtn" class="btn secondary">é€±å ±ã‚’ä½œæˆ</button>
          </div>
        </div>
      </div>

      <div class="kpi"><span>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆéå»7æ—¥ï¼‰</span></div>
      <div class="bar"><i id="scoreFill"></i></div>

      <div id="log" class="log">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
  </div>

  <script>
    // ---------- ãƒ†ãƒ¼ãƒä¿æŒ ----------
    const root = document.documentElement;
    const toggle = document.getElementById('toggle');
    const saved = localStorage.getItem('theme') || 'dark';
    root.setAttribute('data-theme', saved);
    if(saved==='dark') toggle.classList.add('on');
    document.getElementById('themeSwitch').addEventListener('click', () => {
      const now = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', now);
      toggle.classList.toggle('on', now==='dark');
      localStorage.setItem('theme', now);
    });

    // ---------- UIå‚ç…§ ----------
    const input = document.getElementById('userInput');
    const log = document.getElementById('log');
    const scoreFill = document.getElementById('scoreFill');
    const reflectBtn = document.getElementById('reflectBtn');
    const weeklyBtn = document.getElementById('weeklyBtn');

    const postJSON = async (url, body) => {
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    };

    const setLoading = (el, v) => {
      el.disabled = v;
      el.style.opacity = v ? .7 : 1;
      el.textContent = v ? 'â€¦å‡¦ç†ä¸­' : (el===reflectBtn?'Reflect':'é€±å ±ã‚’ä½œæˆ');
    };

    // ---------- é€ä¿¡ï¼ˆReflectï¼‰ ----------
    const doReflect = async () => {
      const text = input.value.trim();
      if(!text) { input.focus(); return; }
      setLoading(reflectBtn, true);
      try{
        const data = await postJSON('/reflect', { user_input: text });
        const { result, score, advice, category, followup } = data || {};
        log.textContent =
`ã€ä»Šæ—¥ã®è¦ç´„ã€‘${result ?? ''}
ã€ã‚¹ã‚³ã‚¢ã€‘${score ?? '-'}
ã€ã‚«ãƒ†ã‚´ãƒªã€‘${category ?? '-'}
ã€æ¬¡ã®ä¸€æ‰‹ã€‘${advice ?? ''}
ã€è³ªå•ã€‘${followup ?? ''}`;
        const v = Math.max(0, Math.min(100, Number(score)||0));
        scoreFill.style.width = `${v}%`;
        input.value = ''; // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
      }catch(e){
        log.textContent = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${e.message||e}`;
      }finally{
        setLoading(reflectBtn, false);
        input.focus();
      }
    };

    // ---------- é€±å ± ----------
    const doWeekly = async () => {
      setLoading(weeklyBtn, true);
      try{
        const data = await postJSON('/weekly_report', {});
        log.textContent = data?.report || JSON.stringify(data, null, 2);
      }catch(e){
        log.textContent = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${e.message||e}`;
      }finally{
        setLoading(weeklyBtn, false);
      }
    };

    reflectBtn.addEventListener('click', doReflect);
    weeklyBtn.addEventListener('click', doWeekly);

    // Enterã§é€ä¿¡ / Ctrl+Enterã¯æ”¹è¡Œ
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.ctrlKey){
        e.preventDefault();
        doReflect();
      }
    });

    /* ===== ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‹ã‚‰åºƒãŒã‚‹â€œæ³¢ç´‹â€ ===== */
    function attachRipple(el){
      el.addEventListener('click', (ev)=>{
        // æ—¢å­˜ã®æ³¢ç´‹ã‚’æƒé™¤
        el.querySelectorAll('.ripple').forEach(n=>n.remove());
        const rect = el.getBoundingClientRect();
        const span = document.createElement('span');
        span.className = 'ripple';
        // ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ï¼ˆãƒœã‚¿ãƒ³å†…ï¼‰ã«é…ç½®
        span.style.left = (ev.clientX - rect.left) + 'px';
        span.style.top  = (ev.clientY - rect.top)  + 'px';
        el.appendChild(span);
        // ã‚¢ãƒ‹ãƒ¡å¾Œã«å‰Šé™¤
        span.addEventListener('animationend', ()=> span.remove());
      });
    }
    [reflectBtn, weeklyBtn].forEach(attachRipple);
  </script>
</body>
</html>
