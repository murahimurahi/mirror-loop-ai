<!-- éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆè‡ªç„¶ãªã—ã‚ƒã¹ã‚Šæ–¹ï¼‰ -->
<script>
speakBtn.addEventListener("click", ()=>{
  if(!("speechSynthesis" in window)){ 
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); 
    return; 
  }

  let txt = result.textContent.trim();
  if(!txt) return;

  // ğŸ’¡ è¨˜å·ã‚„è¦‹å‡ºã—ãªã©ã‚’é™¤å¤–ã—ã¦è‡ªç„¶ãªè©±ã—æ–¹ã«æ•´å½¢
  txt = txt
    .replace(/ğŸ’¡/g, "")
    .replace(/è¦ç´„[:ï¼š]/g, "")
    .replace(/åŠ©è¨€[:ï¼š]/g, "")
    .replace(/æ¬¡ã®ä¸€è¨€[:ï¼š]/g, "")
    .replace(/ãƒ»/g, "ã€")
    .replace(/\s+/g, " ")
    .replace(/\n+/g, "ã€‚")
    .replace(/[ã€‚]{2,}/g, "ã€‚");

  // èª­ã¿ä¸Šã’é€Ÿåº¦ãƒ»ãƒ”ãƒƒãƒã‚’èª¿æ•´ã—ã¦è‡ªç„¶ãªã—ã‚ƒã¹ã‚Š
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "ja-JP";
  u.rate = 0.95;   // å°‘ã—ã‚†ã£ãã‚Š
  u.pitch = 0.9;   // è½ã¡ç€ã„ãŸå£°
  u.volume = 1.0;

  // æ–‡ã”ã¨ã«å°‘ã—é–“ã‚’ç©ºã‘ã¦èª­ã‚€ï¼ˆå¥èª­ç‚¹ã§ãƒãƒ¼ã‚ºï¼‰
  const sentences = txt.split(/(?<=[ã€‚ï¼ï¼Ÿ])/);
  speechSynthesis.cancel();
  let i = 0;
  const speakNext = ()=>{
    if(i < sentences.length){
      const part = new SpeechSynthesisUtterance(sentences[i]);
      part.lang = u.lang; part.rate = u.rate; part.pitch = u.pitch; part.volume = u.volume;
      speechSynthesis.speak(part);
      part.onend = ()=>{ setTimeout(speakNext, 250); }; // 0.25ç§’é–“
      i++;
    }
  };
  speakNext();
});
</script>
