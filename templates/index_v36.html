<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mirror Loop v0.3.6</title>
<style>
:root{
  --card-w: 560px; --r:16px;
  --glass: rgba(15,18,32,.55); --bdr: rgba(255,255,255,.08);
  --c1:#66d3ff; --c2:#2b6fff; --bg:#0b1220; --txt:#eaf1ff;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--txt); background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
/* æœ€åˆã®â€œä¸­å¿ƒã‹ã‚‰â€å‘¼å¸æ¼”å‡ºï¼ˆæˆ»ã—ï¼‰ */
.bg{position:fixed; inset:0; z-index:-1; background:radial-gradient(1200px 1200px at 50% 50%, rgba(70,140,255,.20), rgba(10,18,32,0) 70%)}
.bg::before{
  content:""; position:absolute; inset:-15%;
  background: radial-gradient(700px 700px at 50% 50%, rgba(100,180,255,.35), rgba(60,100,200,.10) 45%, rgba(10,18,32,0) 70%);
  filter: blur(40px); animation:breathe 6s ease-in-out infinite; transform-origin:50% 50%;
}
@keyframes breathe{0%{transform:scale(.94);opacity:.75}50%{transform:scale(1.05);opacity:1}100%{transform:scale(.94);opacity:.75}}

.wrap{width:min(92dvw,var(--card-w))}
.card{
  background:var(--glass); border:1px solid var(--bdr); border-radius:var(--r); padding:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04); backdrop-filter:blur(12px);
}
.title{display:flex; gap:10px; align-items:center; font-weight:700; margin-bottom:10px}
.dot{width:12px;height:12px;border-radius:50%;background:var(--c1);box-shadow:0 0 12px var(--c1)}

.hint{font-size:.92rem;color:#b9c9ee;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:12px;padding:10px 12px;margin-bottom:10px}
.hint b{color:#fff}

.row{display:flex; gap:10px; align-items:center}
.grow{flex:1}

textarea{
  width:100%; height:120px; resize:vertical; border-radius:12px; outline:none;
  background:rgba(255,255,255,.03); color:var(--txt); border:1px solid var(--bdr); padding:14px 16px;
}
textarea::placeholder{color:#9fb3d9}

.btn{
  position:relative; border:none; cursor:pointer; border-radius:12px; padding:12px 14px; font-weight:700;
  color:#06223a; background:var(--c1); box-shadow:0 6px 16px rgba(102,211,255,.35); overflow:hidden;
  transition:transform .08s ease, box-shadow .2s ease, filter .2s ease;
}
.btn.alt{background:var(--c2); color:#fff; box-shadow:0 6px 16px rgba(43,111,255,.35)}
.btn.icon{width:46px; padding:10px}
.btn:active{transform:translateY(1px)}
.btn:disabled{filter:saturate(.4) brightness(.8); cursor:not-allowed}

/* ã¼ã‚“ã‚„ã‚Šå¸¸æ™‚ç™ºå…‰ */
.btn::before{
  content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit;
  background:radial-gradient(circle at center, rgba(255,255,255,.35) 0%, rgba(255,255,255,.10) 40%, transparent 70%);
  animation:pulse 4.5s ease-in-out infinite; opacity:.55; transform:scale(.95);
}
@keyframes pulse{0%{opacity:.35;transform:scale(.92)}50%{opacity:.7;transform:scale(1.04)}100%{opacity:.35;transform:scale(.92)}}

/* ã‚¯ãƒªãƒƒã‚¯æ³¢ç´‹ï¼ˆãƒœãƒ¤ãƒƒâ†’åºƒãŒã‚‹ï¼‰ */
.btn .ripple{
  position:absolute; border-radius:9999px; transform:translate(-50%,-50%); pointer-events:none;
  width:12px; height:12px; background:rgba(255,255,255,.55); mix-blend-mode:screen;
  animation:ripple .6s ease-out forwards;
}
@keyframes ripple{from{opacity:.6; transform:translate(-50%,-50%) scale(.5)} to{opacity:0; transform:translate(-50%,-50%) scale(12)}}

.result{background:rgba(255,255,255,.03); border:1px solid var(--bdr); border-radius:12px; padding:12px; min-height:56px; white-space:pre-wrap; font-family:ui-monospace,Menlo,Consolas,monospace}
.score{height:10px; border-radius:999px; background:rgba(255,255,255,.06); overflow:hidden; margin-top:6px}
.score>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--c1),var(--c2)); transition:width .35s ease}
.small{font-size:.85rem; color:#9fb3d9; margin-top:8px}
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="wrap">
    <div class="card">
      <div class="title"><span class="dot"></span>Mirror Loop v0.3.6</div>

      <!-- ä½¿ã„æ–¹ï¼ˆç°¡æ½”ï¼‰ -->
      <div class="hint">
        <b>ä½¿ã„æ–¹ï¼š</b> â‘  ä¸Šã®æ¬„ã«ä»Šæ—¥ã®ä¸€è¨€ãƒ¡ãƒ¢ â†’ â‘¡ <b>Reflect</b> â†’
        â‘¢ å‡ºãŸåŠ©è¨€ã‹ã‚‰<b>ä»Šæ—¥ã®ä¸€æ­©</b>ã‚’æ±ºã‚ã‚‹ã€‚é€±æœ«ã¯ <b>é€±å ±ã‚’ä½œæˆ</b> ã‚’æŠ¼ã™ã ã‘ã€‚
      </div>

      <div class="row">
        <textarea id="input" class="grow" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯è½ã¡ç€ã„ã¦éã”ã›ãŸ"></textarea>
        <button id="micBtn" class="btn icon" title="éŸ³å£°å…¥åŠ›">&#127908;</button>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="reflect" class="btn grow">Reflect</button>
        <button id="weekly"  class="btn alt grow">é€±å ±ã‚’ä½œæˆ</button>
        <button id="speak"   class="btn icon" title="éŸ³å£°ã§èª­ã‚€">&#128266;</button>
      </div>

      <div id="result" class="result"></div>
      <div class="score" title="æ„Ÿæƒ…ã‚¹ã‚³ã‚¢"><i id="bar"></i></div>
      <div class="small">â€» éŸ³å£°å…¥åŠ›ãƒ»èª­ã¿ä¸Šã’ã¯Chromeç³»ãƒ–ãƒ©ã‚¦ã‚¶ï¼†HTTPSã§å‹•ä½œã—ã¾ã™ã€‚</div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const input = $("#input"), result = $("#result"), bar = $("#bar");
const btnR = $("#reflect"), btnW = $("#weekly"), micBtn = $("#micBtn"), speakBtn = $("#speak");

/* ã‚¯ãƒªãƒƒã‚¯æ³¢ç´‹ */
function ripple(e){
  const r = document.createElement("span");
  const rect = e.currentTarget.getBoundingClientRect();
  r.className = "ripple";
  r.style.left = (e.clientX - rect.left) + "px";
  r.style.top  = (e.clientY - rect.top)  + "px";
  e.currentTarget.appendChild(r);
  setTimeout(()=>r.remove(), 650);
}
[btnR, btnW, micBtn, speakBtn].forEach(b => b.addEventListener("click", ripple));

/* ãƒ•ã‚§ãƒƒãƒã«10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ */
async function withTimeout(p, ms=10000){ return await Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰")), ms))]); }

/* Reflect */
btnR.addEventListener("click", async ()=>{
  const text = input.value.trim();
  if(!text){ input.focus(); return; }

  btnR.disabled = btnW.disabled = micBtn.disabled = speakBtn.disabled = true;
  result.textContent = "AIãŒè€ƒãˆã¦ã„ã¾ã™â€¦";

  try{
    const res = await withTimeout(fetch("/reflect",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_input:text})
    }));
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||"Server error");

    // â˜…ã‚«ãƒ†ã‚´ãƒªã¯UIè¡¨ç¤ºã—ãªã„
    const adv = (data.advice||[]).map(a=>"ãƒ»"+a).join("\n");
    result.textContent = `è¦ç´„: ${data.summary}\nåŠ©è¨€:\n${adv}\næ¬¡ã®ä¸€è¨€: ${data.followup}`;

    const s = Math.max(0, Math.min(100, +data.score||0));
    bar.style.width = s + "%";

    // å…¥åŠ›æ¬„ã¯é€ä¿¡å¾Œã«ã‚¯ãƒªã‚¢ï¼ˆplaceholderã¯æ®‹ã™ï¼‰
    input.value = "";
  }catch(e){
    result.textContent = "ã‚¨ãƒ©ãƒ¼: " + (e.message||e);
  }finally{
    btnR.disabled = btnW.disabled = micBtn.disabled = speakBtn.disabled = false;
  }
});

/* é€±å ±ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ */
btnW.addEventListener("click", async ()=>{
  btnR.disabled = btnW.disabled = micBtn.disabled = speakBtn.disabled = true;
  result.textContent = "é€±å ±ã‚’ä½œæˆä¸­â€¦";
  try{
    const res = await withTimeout(fetch("/weekly_report",{method:"POST"}));
    const data = await res.json();
    result.textContent = data.report||"OK";
  }catch(e){
    result.textContent = "ã‚¨ãƒ©ãƒ¼: " + (e.message||e);
  }finally{
    btnR.disabled = btnW.disabled = micBtn.disabled = speakBtn.disabled = false;
  }
});

/* éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech API: Chromeç³»ã®ã¿ï¼‰ */
let rec, recognizing = false;
function ensureRecognizer(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "ja-JP";
  r.interimResults = true;
  r.continuous = false;
  return r;
}
micBtn.addEventListener("click", ()=>{
  if(recognizing && rec){ rec.stop(); return; }
  rec = ensureRecognizer();
  if(!rec){ alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChromeæ¨å¥¨ï¼‰"); return; }
  recognizing = true;
  micBtn.textContent = "â—"; // éŒ²éŸ³ä¸­è¡¨ç¤º
  rec.onresult = (ev)=>{
    let final = "";
    for(let i=0;i<ev.results.length;i++){
      const res = ev.results[i];
      if(res.isFinal) final += res[0].transcript;
      else input.value = (input.value.replace(/\s+$/,"") + " " + res[0].transcript).trim();
    }
    if(final) input.value = final;
  };
  rec.onerror = ()=>{ recognizing=false; micBtn.textContent="ğŸ¤"; };
  rec.onend = ()=>{ recognizing=false; micBtn.textContent="ğŸ¤"; };
  rec.start();
});

/* éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆSpeech Synthesisï¼‰ */
speakBtn.addEventListener("click", ()=>{
  if(!("speechSynthesis" in window)){ alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }
  const txt = result.textContent.trim();
  if(!txt) return;
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "ja-JP";
  u.rate = 1.0;
  u.pitch = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
});
</script>
</body>
</html>
